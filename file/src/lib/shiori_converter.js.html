<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/lib/shiori_converter.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/Narazaka/shiori_converter.js.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/shiori_converter.js~ShioriConverter.html">ShioriConverter</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/lib/shiori_converter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

if (typeof require !== &apos;undefined&apos;) {
  var ShioriJK = require(&apos;shiorijk&apos;);
}

/**
 * SHIORI/2.x/3.x/4.x Converter
 */
class ShioriConverter {
  /**
   * convert request to specified version
   * @param {ShioriJK.Message.Request} request - request
   * @param {string} version - protocol version
   * @return {ShioriJK.Message.Request} specified version request
   */
  static request_to(request, version) {
    if (!request) throw new ShioriConverter.RequestNotSetError();
    if (request.request_line.version === &apos;4.0&apos;) {
      if (version === &apos;4.0&apos;) {
        return request;
      } else if (version === &apos;3.0&apos;) {
        return ShioriConverter.request_4to3(request);
      } else {
        return ShioriConverter.request_4to2(request);
      }
    } else if (request.request_line.version === &apos;3.0&apos;) {
      if (version === &apos;4.0&apos;) {
        return ShioriConverter.request_3to4(request);
      } else if (version === &apos;3.0&apos;) {
        return request;
      } else {
        return ShioriConverter.request_3to2(request);
      }
    } else {
      if (version === &apos;4.0&apos;) {
        return ShioriConverter.request_2to4(request);
      } else if (version === &apos;3.0&apos;) {
        return ShioriConverter.request_2to3(request);
      } else {
        return request;
      }
    }
  }

  /**
   * convert response to specified version
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @param {string} version - protocol version
   * @return {ShioriJK.Message.Response} specified version response
   */
  static response_to(request, response, version) {
    if (!request) throw new ShioriConverter.RequestNotSetError();
    if (!response) throw new ShioriConverter.ResponseNotSetError();
    if (response.status_line.version === &apos;4.0&apos;) {
      if (version === &apos;4.0&apos;) {
        return response;
      } else if (version === &apos;3.0&apos;) {
        return ShioriConverter.response_4to3(request, response);
      } else {
        return ShioriConverter.response_4to2(request, response);
      }
    } else if (response.status_line.version === &apos;3.0&apos;) {
      if (version === &apos;4.0&apos;) {
        return ShioriConverter.response_3to4(request, response);
      } else if (version === &apos;3.0&apos;) {
        return response;
      } else {
        return ShioriConverter.response_3to2(request, response);
      }
    } else {
      if (version === &apos;4.0&apos;) {
        return ShioriConverter.response_2to4(request, response);
      } else if (version === &apos;3.0&apos;) {
        return ShioriConverter.response_2to3(request, response);
      } else {
        return response;
      }
    }
  }

  /**
   * convert SHIORI/4.x request to SHIORI/3.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/3.x request
   */
  static request_4to3(request) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/4.x request to SHIORI/2.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/2.x request
   */
  static request_4to2(request) {
    return ShioriConverter.request_3to2(
      ShioriConverter.request_4to3(request)
    );
  }

  /**
   * SHIORI/3.x request method to SHIORI/2.x request method
   * @param {ShioriJK.Message.Request} request - request
   * @return {string} method
   */
  static method3to2(request) {
    const id = request.headers.header.ID;
    if (id === &apos;version&apos;) {
      return &apos;GET Version&apos;;
    } else if (id === &apos;OnTeach&apos;) {
      return &apos;TEACH&apos;;
    } else if (id === &apos;ownerghostname&apos;) {
      return &apos;NOTIFY OwnerGhostName&apos;;
    } else if (id === &apos;otherghostname&apos;) {
      return &apos;NOTIFY OtherGhostName&apos;;
    } else if (request.request_line.method === &apos;NOTIFY&apos;) {
      return; // No SHIORI 2.x Event
    } else if (id.match(/^[a-z]/)) {
      return &apos;GET String&apos;; // default SHIORI/2.5
    } else {
      return &apos;GET Sentence&apos;; // default SHIORI/2.2
    }
  }

  /**
   * convert SHIORI/3.x request to SHIORI/2.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/2.x request
   */
  static request_3to2(request) {
    /*
    SHIORI/2.x&#x4E92;&#x63DB;&#x5909;&#x63DB;
    - GET : Sentence : OnCommunicate &#x306F;GET Sentence SHIORI/2.3&#x306B;&#x5909;&#x63DB;&#x3055;&#x308C;&#x3001;&#x30D8;&#x30C3;&#x30C0;&#x306E;&#x4F4D;&#x7F6E;&#x304C;&#x5909;&#x66F4;&#x3055;&#x308C;&#x307E;&#x3059;&#x3002;
    - GET : TEACH : OnTeach &#x306F;TEACH SHIORI/2.4&#x306B;&#x5909;&#x63DB;&#x3055;&#x308C;&#x3001;&#x30D8;&#x30C3;&#x30C0;&#x306E;&#x4F4D;&#x7F6E;&#x304C;&#x5909;&#x66F4;&#x3055;&#x308C;&#x307E;&#x3059;&#x3002;
    */
    const method = ShioriConverter.method3to2(request);
    if (!method) {
      return; // No SHIORI 2.x Event
    }
    const id = request.headers.header.ID;

    const headers = new ShioriJK.Headers.Request();
    const conv_request = new ShioriJK.Message.Request({
      request_line: new ShioriJK.RequestLine({
        method: method,
        protocol: request.protocol,
        version: &apos;2.6&apos;,
      }),
      headers: headers,
    });

    if (method === &apos;GET Sentence&apos; &amp;&amp; id != null) {
      if (id === &apos;OnCommunicate&apos;) { // SHIORI/2.3b
        headers.header[&apos;Sender&apos;] = request.headers.header[&apos;Reference0&apos;];
        headers.header[&apos;Sentence&apos;] = request.headers.header[&apos;Reference1&apos;];
        headers.header[&apos;Age&apos;] = request.headers.header.Age || &apos;0&apos;;
        // ref0,1&#x306E;&#x305F;&#x3081;&#x306B;&#x30D8;&#x30C3;&#x30C0;&#x3092;&#x305A;&#x3089;&#x3059;
        for (const name in request.headers.header) {
          const value = request.headers.header[name];
          let result;
          if (result = name.match(/^Reference(\d+)$/)) {
            headers.header[&apos;Reference&apos; + (result[1] - 2)] = &apos;&apos; + value;
          } else {
            headers.header[name] = &apos;&apos; + value;
          }
        }
        return conv_request;
      } else { // SHIORI/2.2
        headers.header[&apos;Event&apos;] = id;
      }
    } else if (method === &apos;GET String&apos; &amp;&amp; id != null) { // SHIORI/2.5
      headers.header[&apos;ID&apos;] = id;
    } else if (method === &apos;TEACH&apos;) { // SHIORI/2.4
      headers.header[&apos;Word&apos;] = request.headers.header[&apos;Reference0&apos;];
      // ref0&#x306E;&#x305F;&#x3081;&#x306B;&#x30D8;&#x30C3;&#x30C0;&#x3092;&#x305A;&#x3089;&#x3059;
      for (const name in request.headers.header) {
        const value = request.headers.header[name];
        let result;
        if (result = name.match(/^Reference(\d+)$/)) {
          headers.header[&apos;Reference&apos; + (result[1] - 1)] = &apos;&apos; + value;
        } else {
          headers.header[name] = &apos;&apos; + value;
        }
      }
      return conv_request;
    } else if (method === &apos;NOTIFY OwnerGhostName&apos;) { // SHIORI/2.0 NOTIFY
      headers.header[&apos;Ghost&apos;] = request.headers.header[&apos;Reference0&apos;];
      return conv_request;
    } else if (method === &apos;NOTIFY OtherGhostName&apos;) { // SHIORI/2.3 NOTIFY
      const ghosts = [];
      for (const name in request.headers.header) {
        const value = request.headers.header[name];
        if (name.match(/^Reference\d+$/)) {
          ghosts.push(&apos;&apos; + value);
        } else {
          headers.header[name] = &apos;&apos; + value;
        }
      }
      const ghosts_headers = ghosts
        .map((ghost) =&gt; `GhostEx: ${ghost}\r\n`)
        .join(&apos;&apos;);
      // ShioriJK.Headers&#x304C;&#x540C;&#x4E00;&#x540D;&#x8907;&#x6570;&#x30D8;&#x30C3;&#x30C0;&#x306B;&#x5BFE;&#x5FDC;&#x3057;&#x3066;&#x3044;&#x306A;&#x3044;&#x305F;&#x3081;
      return conv_request.request_line
        + &apos;\r\n&apos;
        + conv_request.headers
        + ghosts_headers
        + &apos;\r\n&apos;;
    } else {
      return;
    }
    for (const name in request.headers.header) {
      if (name === &apos;ID&apos;) continue;
      const value = request.headers.header[name];
      headers.header[name] = &apos;&apos; + value;
    }
    return conv_request;
  }

  /**
   * convert SHIORI/2.x request to SHIORI/3.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/3.x request
   */
  static request_2to3(request) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/3.x request to SHIORI/4.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/4.x request
   */
  static request_3to4(request) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/2.x request to SHIORI/4.x
   * @param {ShioriJK.Message.Request} request - request
   * @return {ShioriJK.Message.Request} SHIORI/4.x request
   */
  static request_2to4(request) {
    return ShioriConverter.request_3to4(
      ShioriConverter.request_2to3(request)
    );
  }

  /**
   * convert SHIORI/4.x response to SHIORI/3.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/3.x response
   */
  static response_4to3(request, response) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/4.x response to SHIORI/2.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/2.x response
   */
  static response_4to2(request, response) {
    return ShioriConverter.response_3to2(
      ShioriConverter.response_4to3(request, response)
    );
  }

  /**
   * convert SHIORI/3.x response to SHIORI/2.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/2.x response
   */
  static response_3to2(request, response) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/2.x response to SHIORI/3.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/3.x response
   */
  static response_2to3(request, response) {
    const conv_request = ShioriConverter.request_to(request, &apos;2.6&apos;);
    let value_name;
    switch (conv_request.request_line.method) {
      case &apos;GET String&apos;:
        value_name = &apos;String&apos;;
        break;
      case &apos;GET Word&apos;:
        value_name = &apos;Word&apos;;
        break;
      case &apos;GET Status&apos;:
        value_name = &apos;Status&apos;;
        break;
      default:
        value_name = &apos;Sentence&apos;;
        break;
    }
    const headers = new ShioriJK.Headers.Response();
    if (response.headers.header[value_name] != null) {
      headers.header.Value = response.headers.header[value_name];
    }
    for (const name in response.headers.header) {
      const value = response.headers.header[name];
      // for Communicate
      let result;
      if (result = name.match(/^Reference(\d+)$/)) {
        headers.header[`Reference${result[1] + 1}`] = value;
      } else if (name === &apos;To&apos;) {
        headers.header.Reference0 = value;
      } else if (name !== value_name) {
        headers.header[name] = value;
      }
    }
    return new ShioriJK.Message.Response({
      status_line: new ShioriJK.StatusLine({
        code: response.status_line.code,
        protocol: response.status_line.protocol,
        version: &apos;3.0&apos;,
      }),
      headers: headers,
    });
  }

  /**
   * convert SHIORI/3.x response to SHIORI/4.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/4.x response
   */
  static response_3to4(request, response) {
    throw new ShioriConverter.NotImplementedError();
  }

  /**
   * convert SHIORI/2.x response to SHIORI/4.x
   * @param {ShioriJK.Message.Request} request - request
   * @param {ShioriJK.Message.Response} response - response
   * @return {ShioriJK.Message.Response} SHIORI/4.x response
   */
  static response_2to4(request, response) {
    return ShioriConverter.response_3to4(
      ShioriConverter.response_2to3(request, response)
    );
  }
}

/**
 * Request not found error
 */
ShioriConverter.RequestNotSetError = class RequestNotSetError extends Error {
};

/**
 * Response not found error
 */
ShioriConverter.ResponseNotSetError = class ResponseNotSetError extends Error {
};

/**
 * Sorry, not implemented!
 */
ShioriConverter.NotImplementedError = class NotImplementedError extends Error {
};

export {ShioriConverter};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
